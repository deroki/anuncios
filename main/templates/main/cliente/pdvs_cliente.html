{% extends 'main/base.html' %}
{% load static %}

{% block logo %}

                        {% if MEDIA_URL %}
                            <img src={{ MEDIA_URL }}/{{ logo_path }}>
                        {% else %}
                            <a href="#"><h1> PEPEAPP </h1></a>
                        {% endif %}
{% endblock %}

{% block css%}<style>
    td.add_button{
        background: url("{% static 'images/icon/add.png' %}") center;
        cursor: pointer;
        background-repeat: no-repeat;
        background-size: 20px 20px;
    }
</style>
{% endblock %}

{#{% block logo %}#}
{##}
{#                        {% if user.is_cliente %}#}
{#                            <img src={{ MEDIA_URL }}/{{ logo }}>#}
{#                        {% else %}#}
{#                            <a href="#"><h1> PEPEAPP </h1></a>#}
{#                        {% endif %}#}
{#{% endblock %}#}


{% block content %}
    <br><br>
    <div class="col-12">
        <div class="card mt-auto">
            <div class="card-body">
                <div class="row">
                    <h1>{{ selected_campana.nombre }}</h1>
                </div>
            </div>
        </div>
    </div>

    <br><br>
    <!-- botones -->
    <div class="col-12">
        <div class="card mt-auto">
            <div class="card-body">
                <div class="row">
{#                    <div class="col-3">#}
{#                        <a href={% url 'crear_campana' %} class="btn btn-dark text-white">Nueva Campa√±a</a>#}
{#                    </div>#}


                </div>
            </div>
        </div>
    </div>
    <!-- tabla -->
    <div class="col-12">
        <div class="card mt-auto">
            <div class="card-body">
                <div class="row">
                    <div class="col-12">
                        <form id="theform" action={% url 'guardar_config_campana' %} method="post">
                        {% csrf_token %}
                        <table id="tabla" class="table table-striped table-bordered" style="width:100%">
                            <thead>
                            <tr>
                                <th class="text-center"></th>
                                <th class="text-center">Pdv</th>
                                <th class="text-center">Nombre</th>
                                <th class="text-center">Cadena</th>
                                <th class="text-center">Idioma</th>
                                <th class="text-center">Ciudad</th>
                                <th class="text-center">Provincia</th>
                                <th class="text-center">Estado</th>
                                <th class="text-center"></th>


                            </tr>
                            </thead>
                            <tbody>
                            {% for pdv in pdvs%}
                                <tr id = {{ pdv.pk }}>
                                    <td class="add_button"
                                    </td>
                                    <td>{{ pdv.slug }}</td>
                                    <td>{{ pdv.nombre }}</td>
                                    <td>{{ pdv.cadena }}</td>
                                    <td>{{ pdv.idioma }}</td>
                                    <td>{{ pdv.ciudad }}</td>
                                    <td>{{ pdv.provincia }}</td>

                                    <td>
                                    {% if pdv.estado == True %}
                                        ok
                                    {% elif pdv.estado == None %}
                                        Incidencia
                                    {% else %}
                                        Incidencia
                                    {% endif %}
                                    </td>

                                    <td> <input class="main_pdv_{{ pdv.pk }}" onclick="togglePdv(this)" type="checkbox" name="pdv_{{ pdv.pk }}" value="True"></td>


                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                        </form>
                    </div>
                </div>

                <div class="col-3">
                    <a href="#" class="btn btn-dark text-white" onclick="document.getElementById('theform').submit();">
                        Guardar PDIs
                    </a>
                </div>
            </div>
        </div>
    </div>
{% endblock%}

{% block javascript %}

{#    <script src="https://code.jquery.com/jquery-3.3.1.js"></script>#}
{#    <script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>#}
{#    <script src="https://cdn.datatables.net/1.10.19/js/dataTables.bootstrap4.min.js"></script>#}
{#    <script src="https://cdn.datatables.net/1.10.19/css/dataTables.bootstrap4.min.css"></script>#}
    <link rel="stylesheet" type="text/css"
          href="https://cdn.datatables.net/v/bs4/jszip-2.5.0/dt-1.10.18/b-1.5.6/b-html5-1.5.6/r-2.2.2/datatables.min.css"/>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
    <script type="text/javascript"
            src="https://cdn.datatables.net/v/bs4/jszip-2.5.0/dt-1.10.18/b-1.5.6/b-html5-1.5.6/r-2.2.2/datatables.min.js"></script>
    <script>
        $(document).ready(function () {
            var table = $('#tabla').DataTable(
                {
                    dom: 'Bfrtip',
                    buttons : ['pdf','excel'],
                    {#columns: [#}
                    {#    {className: 'details-control',#}
                    {#        orderable: false,#}
                    {#        data: null,#}
                    {#        defaultContent: ''},#}
                    {#    {data: "Nombre"},#}
                    {#    {data: "Finalizada"},#}
                    {#    {data: "Estado"},#}
                    {#    {data: "Activo"}]#}
                }
            )

            function format(d) {
                // `d` is the original data object for the row
                return '<table cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;">' +
                    '<tr>' +
                    '<td>Nombre</td>' +
                    '<td>' + d.name + '</td>' +
                    '</tr>' +
                    '<tr>' +
                    '<td>Extension number:</td>' +
                    '<td>' + d.extn + '</td>' +
                    '</tr>' +
                    '<tr>' +
                    '<td>Extra info:</td>' +
                    '<td>And any further details here (images etc)...</td>' +
                    '</tr>' +
                    '</table>';
            }

            function createtable(json, materiales, creatividades, pdv_pk){
                let tabla = '<table class="extended">';
                tabla += `<thead>
                            <tr>
                                <th class="text-center">Nombre</th>
                                <th class="text-center">Tipo</th>
                                <th class="text-center">Ancho Total</th>
                                <th class="text-center">Ancho Vista</th>
                                <th class="text-center">Alto Total</th>
                                <th class="text-center">Alto Vista</th>
                                <th class="text-center">Composicion</th>
                                <th class="text-center">Activo</th>
                                <th class="text-center">Instaladores</th>
                                <th class="text-center">Material</th>
                                <th class="text-center">Creatividad</th>
                                <th class="text-center"></th>

                            </tr>
                            </thead>`;
                tabla += '<tbody>';
                for (var rrow in json){
                    tabla+= '<tr>';
                    tabla += '<td class="text-center">' + json[rrow].nombre + '</td>';
                    tabla += '<td class="text-center">' + json[rrow].tipo + '</td>';
                    tabla += '<td class="text-center">' + json[rrow].altoTotal + '</td>';
                    tabla += '<td class="text-center">' + json[rrow].altoVista+ '</td>';
                    tabla += '<td class="text-center">' + json[rrow].anchoTotal + '</td>';
                    tabla += '<td class="text-center">' + json[rrow].anchoVista+ '</td>';
                    tabla += '<td class="text-center">' + json[rrow].composicion + '</td>';
                    tabla += '<td class="text-center">' + json[rrow].activo + '</td>';
                    tabla += '<td class="text-center">' + json[rrow].instaladores + '</td>';
                    //material actual
                    tabla += '<td class="text-center">' + json[rrow].material ;
                    //material a elegir
                    tabla += `<select name="pdi_${json[rrow]['id']}_material">`;
                    for (var index in materiales) {
                        let id = materiales[index]['id'];
                        let nombre = materiales[index]['nombre'];
                        tabla += `<option value="${id}">${nombre}</option>`;
                    }
                    tabla += '</select>';
                    tabla += '</td>';
                    //creatividad inicial
                    tabla += '<td class="text-center">' + json[rrow].creatividad ;
                    //creatividad a elegir
                    tabla+= `<select name="pdi_${json[rrow]['id']}_creatividad">`;

                    for (var index in creatividades){
                        let id = creatividades[index]['id'];
                        let nombre = creatividades[index]['nombre'];
                        tabla += `<option value="${id}">${nombre}</option>`;
                        }
                    tabla+= '</select>';
                    tabla+= '</td>';
                    //check
                    tabla+= `<td> <input class="pdv_${pdv_pk}" onclick="togglePdi(this)"type="checkbox" name="pdi_${json[rrow]['id']}" value="${json.checked}"></td>`




                    }
                tabla+= '</tr>';
                tabla += '</body>';
                tabla += '</table>';
                return tabla
                }



            $('#tabla tbody').on('click', 'td.add_button', function () {
                console.log("buton pulsadoo");
                var tr = $(this).closest('tr');
                var row = table.row(tr);
                var pdi_pk = tr.attr('id');

                if (row.child.isShown()) {
                    row.child.hide();
                    tr.removeClass('shown');
                } else {

                    if(row.child() && row.child().length){
                        row.child.show();
                    }
                    else{
                    $.ajax({
                    'url': {% url 'pdis_json' %},
                    'data' : {'pdv_pk': pdi_pk },
                    'dataType': 'json',
                    'success': function(json){
                        tabla = createtable(json.data,json.materiales,json.creatividades, json.pdv_pk);
                        row.child(tabla).show();
                        tr.addClass('shown')
                    }
                    });
                    }

                }
            });



        });

        function togglePdv(source){
                var pdvClass = source.className;
                var pdvNum = pdvClass.slice(9);
                console.log(pdvNum);
                var checkboxes = document.getElementsByClassName(`pdv_${pdvNum}`);
                for (var index in checkboxes){
                    checkboxes[index].checked = source.checked
                }
            }
        function togglePdi(source){
                if (source.checked === true) {
                    var pdvClass = source.className;
                    var pdvNum = pdvClass.slice(4);
                    console.log(pdvNum);
                    var pdvCheckbox = document.getElementsByClassName(`main_pdv_${pdvNum}`)[0];
                    pdvCheckbox.checked = source.checked;
                }
            }
    </script>
{% endblock %}